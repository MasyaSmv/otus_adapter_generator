# otus-adapter-generator

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ –¥–ª—è PHP-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —Å –ø–æ–º–æ—â—å—é Reflection –∏ –ø—Ä–æ—Å—Ç–æ–≥–æ IoC.

---

## üì¶ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

* **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–¥–∞–ø—Ç–µ—Ä–æ–≤** –ø–æ –ª—é–±–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É:

    * –ú–µ—Ç–æ–¥—ã `getX()` –≤—ã–∑—ã–≤–∞—é—Ç `IoC::resolve('X', "Interface:x.get", $obj)` –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ.
    * –ú–µ—Ç–æ–¥—ã `setX($v)` —Å–æ–∑–¥–∞—é—Ç –∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç –∫–æ–º–∞–Ω–¥—É `ICommand` —á–µ—Ä–µ–∑ IoC: `IoC::resolve(ICommand::class, "Interface:x.set", $obj, $v)->execute()`.
    * –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤—ã–∑—ã–≤–∞—é—Ç `IoC::resolve('<ReturnType>'|ReturnType::class, "Interface:method", $obj, ...args)`.
* **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∏–ª–µ–π –∏–º–µ–Ω** –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤:

    * `IUser` ‚Üí `UserAdapter`
    * `UserInterface` ‚Üí `UserAdapter`
    * `Some` ‚Üí `SomeAdapter`
* **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–∞–∑–±–∏—Ç –Ω–∞ –º–µ–ª–∫–∏–µ —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.
* **–ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏** –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—ë –Ω–µ –±—ã–ª–æ.
* **–ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä PHPUnit-—Ç–µ—Å—Ç–æ–≤**: –ø–æ–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –≤–µ—Ç–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–≥–µ—Ç—Ç–µ—Ä—ã, —Å–µ—Ç—Ç–µ—Ä—ã, –æ–±—â–∏–µ –º–µ—Ç–æ–¥—ã, –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞).
* **CI –Ω–∞ GitHub Actions**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—É—à–µ –∏ PR.

---

## üõ† –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

* PHP ‚â• 8.0
* Composer
* –†–∞–∑—Ä–∞–±–æ—Ç—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (phpunit/phpunit ^10)

---

## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –°–æ–∑–¥–∞–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä:

   ```php
   <?php
   namespace MyApp;

   interface IWidget
   {
       public function getPosition(): array;
       public function setPosition(array $pos): void;
       public function render(string $mode): string;
   }
   ```

2. –í—ã–∑–æ–≤–∏—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤ —Å–∫—Ä–∏–ø—Ç–µ –∏–ª–∏ —Ç–µ—Å—Ç–µ:

   ```php
   use Masyasmv\Adapter\AdapterGenerator;

   require 'vendor/autoload.php';

   $gen = new AdapterGenerator();
   $gen->generate(
       interfaceFqcn: MyApp\IWidget::class,
       outputDir: __DIR__ . '/src/AutoGenerated'
   );
   ```

3. –í –ø–∞–ø–∫–µ `src/AutoGenerated` –ø–æ—è–≤–∏—Ç—Å—è —Ñ–∞–π–ª `WidgetAdapter.php`:

   ```php
   namespace MyApp\AutoGenerated;

   use ICommand;
   use IoC;

   class WidgetAdapter implements \MyApp\IWidget
   {
       private object $obj;

       public function __construct(object $obj)
       {
           $this->obj = $obj;
       }

       public function getPosition(): array
       {
           return IoC::resolve('array', "MyApp\\IWidget:position.get", $this->obj);
       }

       public function setPosition(array $pos): void
       {
           IoC::resolve(ICommand::class, "MyApp\\IWidget:position.set", $this->obj, $pos)
               ->execute();
       }

       public function render(string $mode): string
       {
           return IoC::resolve(string::class, "MyApp\\IWidget:render", $this->obj, $mode);
       }
   }
   ```

---

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å IoC

**–ü—Ä–∏–º–µ—Ä –¥–ª—è –ª—é–±–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:**

```php
$container->set('AdapterFactory', function() {
    return function(string $iface, object $obj) {
        $short = (new \ReflectionClass($iface))->getShortName();
        // –û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º I- –∏–ª–∏ Interface
        if (str_starts_with($short, 'I')) {
            $base = substr($short, 1);
        } elseif (str_ends_with($short, 'Interface')) {
            $base = substr($short, 0, -strlen('Interface'));
        } else {
            $base = $short;
        }

        $adapter = $base . 'Adapter';
        $ns      = (new \ReflectionClass($iface))->getNamespaceName() . '\\AutoGenerated';
        $class   = $ns . '\\' . $adapter;
        return new $class($obj);
    };
});
```

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
vendor/bin/phpunit --colors=always
```

–ö–µ–π—Å—ã –≤ `tests/Unit` –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–µ—Ç–∫–∏ —Ä–∞–±–æ—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞.

---

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è

MIT ¬© Masya Smv
